<head>
    <style> body { margin: 0; } </style>
  
    <script src="https://unpkg.com/d3-dsv@3.0.1/dist/d3-dsv.min.js"></script>
    <script src="https://unpkg.com/index-array-by@1.3.2/dist/index-array-by.min.js"></script>
    <script src="https://unpkg.com/d3@7.4.4/dist/d3.min.js"></script>
  
    <script src="https://unpkg.com/globe.gl@2.26.1/dist/globe.gl.min.js"></script>
    <!--<script src="../../dist/globe.gl.js"></script>-->
  </head>
  
  <body>
  <div id="globeViz"></div>
  
  <script>

    //const OPACITY = 0.4;
    const colorScale = d3.scaleSequentialSqrt(d3.interpolateYlOrRd);

    // GDP per capita (avoiding countries with small pop)
    const getVal = feat => feat.properties.GDP_MD_EST / (5 * 1e7); //  / Math.max(1e5, feat.properties.POP_EST);

    fetch('./dataset/classifications_data/ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries =>
    {
        fetch('./dataset/geo_export.json').then(x => x.json()).then(exports =>
        {
            const myGlobe = Globe()
            (document.getElementById('globeViz'))  
            .globeImageUrl('https://unpkg.com/three-globe@2.24.4/example/img/earth-night.jpg')
            .backgroundImageUrl('https://unpkg.com/three-globe@2.24.4/example/img/night-sky.png')
            .pointOfView({ lat: 39.6, lng: -98.5, altitude: 2 }) // aim at continental US centroid

            //.arcDashLength(0.5)
            //.arcDashGap(0.5)
            //.arcDashInitialGap(() => Math.random())
            //.arcDashAnimateTime(2000)

            .arcDashLength(0.1)
            .arcDashGap(0.1)
            .arcDashAnimateTime(2000)
            .onArcHover(hoverArc => {
                console.log("here")
                if(hoverArc== null){
                    myGlobe.arcColor(d => {
                        return d.original_color;
                });
                }else{
                    myGlobe.arcColor(d => {                     
                    var split_color = hoverArc.color.substring(5, hoverArc.color.length-1).split(",");
                    //const op = !hoverArc ? split_color[3] : d === hoverArc ? 0.9 : split_color[3] / 4;
                    const op = hoverArc == d? 1:0.15
                    return `rgba(${split_color[0]}, ${split_color[1]}, ${split_color[2]}, ${op})`;
                });

                }                               
                
            })



            //.arcColor(d => [`rgba(0, 255, 0, ${OPACITY})`, `rgba(255, 0, 0, ${OPACITY})`])
            .arcColor('color')
            .arcsTransitionDuration(0)
            .onGlobeClick(reset)
            .onPolygonClick(radiate_arcs)
            .arcStroke("stroke")
            //airport
            .lineHoverPrecision(0)
            .polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ'))
            .polygonAltitude(0.02)
            .polygonCapColor(feat => colorScale(getVal(feat)))
            .polygonSideColor(() => 'rgba(0, 100, 0, 0.15)')
            .polygonStrokeColor(() => '#111')
            .polygonsTransitionDuration(300)


            var neutral = false

            function reset({ lat: endLat, lng: endLng }) {
                myGlobe.arcsData([]);
                myGlobe.polygonCapColor(feat => colorScale(getVal(feat)))
                myGlobe.labelsData([])
            }
            function radiate_arcs(polygon, event, { lat: clicklat, lng:clicklng, altitude }){
                reset(10,10)
                //const arc = { startLat: startlat, startLng: startlng, endLat:39.6, endLng:-98.5 };
                //myGlobe.arcsData([...myGlobe.arcsData(), arc]);
                var arcArray = 0                
                if(polygon.properties.ADMIN == "France" || polygon.properties.ADMIN == "Norway" || polygon.properties.ADMIN == "Kosovo" ){
                    switch(polygon.properties.ADMIN) {
                        case "France":
                            arcArray = exports["FRA"];
                            break;
                        case "Norway":
                            arcArray = exports["NOR"];
                            break; 
                        case "Kosovo":
                            arcArray = exports["XKX"];
                            break; 
                    }
                }else{
                    arcArray = exports[polygon.properties.ISO_A3];
                }
                //console.log(exports[polygon.properties.ISO_A3]);                
                var allArcs = []
                for (var i = 0; i < arcArray.length; i++) {
                    var newArc = {
                        startLat: arcArray[i][3],
                        startLng: arcArray[i][4],
                        endLat: arcArray[i][7],
                        endLng: arcArray[i][8],
                        //color: [['red', 'white', 'blue', 'green'][Math.round(Math.random() * 3)], ['red', 'white', 'blue', 'green'][Math.round(Math.random() * 3)]]
                        color: `rgba(255, 0, 0 , ${Math.min(Math.max(arcArray[i][9] * 15, 0.3) , 0.8)})`,
                        original_color: `rgba(255, 0, 0 , ${Math.min(Math.max(arcArray[i][9] * 15, 0.3) , 0.8)})`,
                        //color: [`rgba(0, 255, 0, 1.50)`, `rgba(255, 0, 0, 1.50)`],
                        //color: "gainsboro",
                        stroke: Math.min(Math.max(arcArray[i][9] * 8, 0.5) , 2) ,
                        name: `${arcArray[i][1]} &#8594; ${arcArray[i][5]} : ${money_amount_fixer(arcArray[i][0])}`
                    }
                    console.log(arcArray[i][9] *255 * 5)
                    allArcs =   [...allArcs, newArc]             
                }
                myGlobe.arcsData(allArcs);    
                //myGlobe.polygonCapColor(d => d === polygon ? 'steelblue' : "lightsalmon")
                myGlobe.polygonCapColor(d => PolygonColorChanger(d,polygon,arcArray))     
                //console.log(exports[polygon.properties.ISO_A3]);
                var clickLabel = ["a", "a", "a","a", "a", "a",arcArray[0][2], arcArray[0][3],arcArray[0][4] ];


                myGlobe.labelsData([...arcArray, clickLabel]);
                myGlobe.labelLat(d => d[7])
                myGlobe.labelLng(d => d[8])
                myGlobe.labelText(d => d[6])
                myGlobe.labelSize(d => 1.2)
                myGlobe.labelDotRadius(d => 0.9)
                myGlobe.labelColor(() => 'darkturquoise')                
                myGlobe.labelResolution(8)
                myGlobe.labelAltitude(0.025)

            }
            function PolygonColorChanger(d,polygon,arcArray){
                var targets_A3 = arcArray.map(x => x[5]);
                var target_Name = arcArray.map(x => x[6]);
                if (d === polygon){
                    console.log(d)
                    return "steelblue"
                }else if(targets_A3.includes(d.properties.ISO_A3) || target_Name.includes(d.properties.ADMIN)){
                    return "lightsalmon"
                }                    
                else{
                    return "grey"
                }
            }
            function money_amount_fixer(amount){
                var fixed_amount = 0
                if (amount > 1000000000){
                    fixed_amount = "$" + (amount / 1000000000).toFixed(2) + "B "
                    
                }
                else if(amount > 1000000){
                    fixed_amount = "$" + (amount / 1000000).toFixed(2) + "M "
                }
                else{
                    fixed_amount = "$" + amount
                }
                return fixed_amount
            }

            

    })});
  
    

    
  </script>
  </body>